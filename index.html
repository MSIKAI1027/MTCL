<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 控制介面</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center">ESP32 自動化控制系統</h2>

  <!-- 模式切換 -->
  <div class="d-flex justify-content-end mb-3">
    <label class="form-label me-2">控制模式：</label>
    <select id="modeSelect" class="form-select w-auto" onchange="changeMode(this.value)">
      <option value="auto">自動</option>
      <option value="remote">遠端</option>
    </select>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="tabMenu" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="io-tab" data-bs-toggle="tab" data-bs-target="#io" type="button">IO 設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="control-tab" data-bs-toggle="tab" data-bs-target="#control" type="button">遠端控制</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logic-tab" data-bs-toggle="tab" data-bs-target="#logic" type="button">自動邏輯</button>
    </li>
  </ul>

  <div class="tab-content" id="tabContent">
    <!-- IO 設定 -->
    <div class="tab-pane fade show active" id="io" role="tabpanel">
      <form id="ioForm">
        <div class="row row-cols-1 row-cols-md-2 g-3">
          <!-- 會由 JS 產生每個 IO 設定項目 -->
        </div>
        <div class="mt-3 text-end">
          <button type="button" class="btn btn-primary" onclick="saveConfig()">儲存設定</button>
        </div>
      </form>
    </div>

    <!-- 遠端控制 -->
    <div class="tab-pane fade" id="control" role="tabpanel">
      <div class="row row-cols-2 row-cols-md-3 g-3" id="controlGrid">
        <!-- 會由 JS 動態生成按鈕 -->
      </div>
    </div>

    <!-- 自動邏輯 -->
    <div class="tab-pane fade" id="logic" role="tabpanel">
      <div class="mb-3">
        <label for="logicInput" class="form-label">控制邏輯（如：IF input0 AND input1 THEN output3）</label>
        <input type="text" id="logicInput" class="form-control" placeholder="輸入邏輯條件..." />
      </div>
      <div class="text-end">
        <button class="btn btn-success" onclick="saveConfig()">儲存邏輯</button>
      </div>
    </div>
  </div>
</div>

<script>
const gpioPins = [2, 4, 5, 12, 13, 14, 15, 18, 19, 21];
let mqttClient;
let currentMode = "auto";

function initMQTT() {
  mqttClient = mqtt.connect("wss://broker.mqttgo.io:8084/mqtt");

  mqttClient.on("connect", () => {
    console.log("MQTT 已連線");
    mqttClient.subscribe("esp32/status");
    mqttClient.subscribe("esp32/ack_config");
    mqttClient.subscribe("esp32/ack_mode");
  });

  mqttClient.on("message", (topic, payload) => {
    const msg = JSON.parse(payload.toString());
    if (topic === "esp32/status") {
      updateStatus(msg);
    }
  });
}

function updateStatus(data) {
  const index = data.index;
  const btn = document.getElementById("btn-" + index);
  if (btn && data.mode === "output") {
    btn.innerText = `${index}: ${data.state}`;
    btn.className = "btn " + (data.state === "high" ? "btn-success" : "btn-secondary");
  }

  if (document.getElementById("modeSelect").value !== data.control) {
    document.getElementById("modeSelect").value = data.control;
    currentMode = data.control;
  }
}

function createIOForm() {
  const form = document.querySelector("#ioForm .row");
  gpioPins.forEach((pin, i) => {
    const col = document.createElement("div");
    col.className = "col";

    col.innerHTML = `
      <label class="form-label">GPIO ${pin}</label>
      <select class="form-select" id="mode-${i}">
        <option value="input">輸入</option>
        <option value="output">輸出</option>
      </select>
    `;
    form.appendChild(col);
  });
}

function createControlButtons() {
  const grid = document.getElementById("controlGrid");
  gpioPins.forEach((pin, i) => {
    const col = document.createElement("div");
    col.className = "col text-center";
    const btn = document.createElement("button");
    btn.id = "btn-" + i;
    btn.className = "btn btn-secondary w-100";
    btn.innerText = `GPIO ${pin}`;
    btn.onclick = () => {
      if (currentMode === "remote") {
        mqttClient.publish("esp32/control", JSON.stringify({ index: i }));
      } else {
        alert("請切換至遠端模式");
      }
    };
    col.appendChild(btn);
    grid.appendChild(col);
  });
}

function saveConfig() {
  const config = {
    gpio: [],
    logic: document.getElementById("logicInput").value
  };
  gpioPins.forEach((pin, i) => {
    const mode = document.getElementById("mode-" + i).value;
    config.gpio.push({ index: i, pin: pin, mode: mode });
  });
  mqttClient.publish("esp32/config", JSON.stringify(config));
}

function changeMode(mode) {
  currentMode = mode;
  mqttClient.publish("esp32/mode", mode);
}

window.onload = () => {
  createIOForm();
  createControlButtons();
  initMQTT();
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
