<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 è‡ªå‹•åŒ–æ§åˆ¶ç³»çµ±</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="p-4">
  <h3 class="mb-4">ESP32 è‡ªå‹•åŒ–æ§åˆ¶ç³»çµ±</h3>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-config" data-bs-toggle="tab" data-bs-target="#pane-config" type="button" role="tab">IO è¨­å®š</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-manage" data-bs-toggle="tab" data-bs-target="#pane-manage" type="button" role="tab">ç®¡ç†ä»‹é¢</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-logic" data-bs-toggle="tab" data-bs-target="#pane-logic" type="button" role="tab">è‡ªå‹•æ§åˆ¶è¨­å®š</button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content mt-3">
    <!-- 1. IO è¨­å®š -->
    <div class="tab-pane fade show active" id="pane-config" role="tabpanel">
      <form id="configForm" class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr><th>ç·¨è™Ÿ</th><th>GPIO</th><th>æ¨¡å¼</th></tr>
          </thead>
          <tbody>
            <script>
              const validPins = [2,4,5,12,13,14,15,18,19,21];
              for (let i = 0; i < 10; i++) {
                document.write(`
                  <tr>
                    <td>${i+1}</td>
                    <td>GPIO ${validPins[i]}</td>
                    <td>
                      <select name="mode${i}" class="form-select">
                        <option value="input">input</option>
                        <option value="output">output</option>
                      </select>
                    </td>
                  </tr>
                `);
              }
            </script>
          </tbody>
        </table>
        <button class="btn btn-primary">å­˜æª”ä¸¦å¥—ç”¨</button>
      </form>
    </div>

    <!-- 2. ç®¡ç†ä»‹é¢ -->
    <div class="tab-pane fade" id="pane-manage" role="tabpanel">
      <table class="table table-bordered text-center">
        <thead>
          <tr><th>ç·¨è™Ÿ</th><th>GPIO</th><th>æ¨¡å¼</th><th>å‹•ä½œæ¨¡å¼</th><th>æŒ‡ç¤ºç‡ˆ</th><th>ç‹€æ…‹</th><th>å–®ä½</th><th>é ç«¯é–‹é—œ</th></tr>
        </thead>
        <tbody id="manageBody">
          <!-- ç”± JS å‹•æ…‹å¡«å…¥ -->
        </tbody>
      </table>
    </div>

    <!-- 3. è‡ªå‹•æ§åˆ¶è¨­å®š -->
    <div class="tab-pane fade" id="pane-logic" role="tabpanel">
      <p>è‡ªå‹•æ§åˆ¶è¨­å®šé é¢å°šåœ¨æ§‹æ€ä¸­ï¼Œæœªä¾†å¯åœ¨æ­¤å®šç¾© IF / AND / OR / OUT ç­‰é‚è¼¯ã€‚</p>
      <!-- ç¯„ä¾‹è¼¸å…¥å€å¡Š -->
      <textarea id="logicTextarea" class="form-control" rows="5" placeholder="EX: IF 2 AND 4 HIGH THEN 12 OUT"></textarea>
      <button id="saveLogicBtn" class="btn btn-secondary mt-2">å­˜æª”é‚è¼¯</button>
    </div>
  </div>

  <pre class="mt-4" id="log">é€£ç·šä¸­...</pre>

  <script>
    const client = mqtt.connect('wss://broker.mqttgo.io:8084/mqtt', {
      clean: true, clientId: 'web_' + Math.random().toString(16).substr(2,8), protocolVersion: 4, reconnectPeriod: 1000
    });
    const log = msg => document.getElementById('log').textContent += `\n${msg}`;

    // åˆå§‹åŒ–ç®¡ç†è¡¨æ ¼
    const manageBody = document.getElementById('manageBody');
    for (let i=0; i<10; i++) {
      manageBody.insertAdjacentHTML('beforeend', `
        <tr id="row${i}">
          <td>${i+1}</td>
          <td>GPIO ${validPins[i]}</td>
          <td id="m_mode${i}">-</td>
          <td id="m_ctrl${i}">é ç«¯</td>
          <td>
            <span id="led${i}" class="badge bg-success">é—œ</span>
          </td>
          <td id="m_state${i}">-</td>
          <td id="m_unit${i}">-</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleIO(${i})">åˆ‡æ›</button>
          </td>
        </tr>
      `);
    }

    client.on('connect', () => {
      log('âœ… å·²é€£ç·š MQTT');
      client.subscribe('esp32/status');      // ESP32 å›å‚³å³æ™‚ç‹€æ…‹
      client.subscribe('esp32/ack_config');  // ESP32 å›å‚³è¨­å®šå®Œæˆ
    });

    client.on('message', (topic, message) => {
      const msg = message.toString();
      log(`ğŸ“¨ ${topic}: ${msg}`);
      if (topic==='esp32/status') {
        // ç¯„ä¾‹ payload: {"index":2,"mode":"output","state":"high","unit":"V"}
        const s = JSON.parse(msg);
        document.getElementById(`m_mode${s.index}`).innerText = s.mode;
        document.getElementById(`m_state${s.index}`).innerText = s.state;
        document.getElementById(`m_unit${s.index}`).innerText = s.unit||'-';
        document.getElementById(`led${s.index}`).innerText = (s.state==='high'?'é–‹':'é—œ');
        document.getElementById(`led${s.index}`).className = 'badge bg-' + (s.state==='high'? 'danger':'success');
      }
      if (topic==='esp32/ack_config') {
        log('ğŸ‰ IO è¨­å®šå·²ç”Ÿæ•ˆ');
      }
    });

    // IO è¨­å®šå­˜æª”
    document.getElementById('configForm').addEventListener('submit', e => {
      e.preventDefault();
      const cfg = { gpio: [], logic: document.getElementById('logicTextarea').value };
      for (let i=0; i<10; i++) {
        cfg.gpio.push({
          index: i,
          pin: validPins[i],
          mode: e.target[`mode${i}`].value
        });
      }
      client.publish('esp32/config', JSON.stringify(cfg));
      log('ğŸ“¤ ç™¼é€ IO è¨­å®š');
    });

    // é ç«¯é–‹é—œæŸä¸€çµ„ IO
    function toggleIO(idx) {
      const msg = { index: idx, cmd: 'toggle' };
      client.publish('esp32/control', JSON.stringify(msg));
      log(`ğŸ“¤ åˆ‡æ› IO ${idx}`);
    }

    // é‚è¼¯å­˜æª”
    document.getElementById('saveLogicBtn').addEventListener('click', () => {
      const logic = document.getElementById('logicTextarea').value;
      client.publish('esp32/config', JSON.stringify({ gpio: [], logic }));
      log('ğŸ“¤ ç™¼é€è‡ªå‹•æ§åˆ¶é‚è¼¯');
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
