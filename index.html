<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 自動化控制系統</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="p-4">
  <h3 class="mb-4">ESP32 自動化控制系統</h3>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-config" data-bs-toggle="tab" data-bs-target="#pane-config" type="button" role="tab">IO 設定</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-manage" data-bs-toggle="tab" data-bs-target="#pane-manage" type="button" role="tab">管理介面</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-logic" data-bs-toggle="tab" data-bs-target="#pane-logic" type="button" role="tab">自動控制設定</button>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content mt-3">
    <!-- 1. IO 設定 -->
    <div class="tab-pane fade show active" id="pane-config" role="tabpanel">
      <form id="configForm" class="table-responsive">
        <table class="table table-bordered text-center">
          <thead>
            <tr><th>編號</th><th>GPIO</th><th>模式</th></tr>
          </thead>
          <tbody>
            <script>
              const validPins = [2,4,5,12,13,14,15,18,19,21];
              for (let i = 0; i < 10; i++) {
                document.write(`
                  <tr>
                    <td>${i+1}</td>
                    <td>GPIO ${validPins[i]}</td>
                    <td>
                      <select name="mode${i}" class="form-select">
                        <option value="input">input</option>
                        <option value="output">output</option>
                      </select>
                    </td>
                  </tr>
                `);
              }
            </script>
          </tbody>
        </table>
        <button class="btn btn-primary">存檔並套用</button>
      </form>
    </div>

    <!-- 2. 管理介面 -->
    <div class="tab-pane fade" id="pane-manage" role="tabpanel">
      <table class="table table-bordered text-center">
        <thead>
          <tr><th>編號</th><th>GPIO</th><th>模式</th><th>動作模式</th><th>指示燈</th><th>狀態</th><th>單位</th><th>遠端開關</th></tr>
        </thead>
        <tbody id="manageBody">
          <!-- 由 JS 動態填入 -->
        </tbody>
      </table>
    </div>

    <!-- 3. 自動控制設定 -->
    <div class="tab-pane fade" id="pane-logic" role="tabpanel">
      <p>自動控制設定頁面尚在構思中，未來可在此定義 IF / AND / OR / OUT 等邏輯。</p>
      <!-- 範例輸入區塊 -->
      <textarea id="logicTextarea" class="form-control" rows="5" placeholder="EX: IF 2 AND 4 HIGH THEN 12 OUT"></textarea>
      <button id="saveLogicBtn" class="btn btn-secondary mt-2">存檔邏輯</button>
    </div>
  </div>

  <pre class="mt-4" id="log">連線中...</pre>

  <script>
    const client = mqtt.connect('wss://broker.mqttgo.io:8084/mqtt', {
      clean: true, clientId: 'web_' + Math.random().toString(16).substr(2,8), protocolVersion: 4, reconnectPeriod: 1000
    });
    const log = msg => document.getElementById('log').textContent += `\n${msg}`;

    // 初始化管理表格
    const manageBody = document.getElementById('manageBody');
    for (let i=0; i<10; i++) {
      manageBody.insertAdjacentHTML('beforeend', `
        <tr id="row${i}">
          <td>${i+1}</td>
          <td>GPIO ${validPins[i]}</td>
          <td id="m_mode${i}">-</td>
          <td id="m_ctrl${i}">遠端</td>
          <td>
            <span id="led${i}" class="badge bg-success">關</span>
          </td>
          <td id="m_state${i}">-</td>
          <td id="m_unit${i}">-</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleIO(${i})">切換</button>
          </td>
        </tr>
      `);
    }

    client.on('connect', () => {
      log('✅ 已連線 MQTT');
      client.subscribe('esp32/status');      // ESP32 回傳即時狀態
      client.subscribe('esp32/ack_config');  // ESP32 回傳設定完成
    });

    client.on('message', (topic, message) => {
      const msg = message.toString();
      log(`📨 ${topic}: ${msg}`);
      if (topic==='esp32/status') {
        // 範例 payload: {"index":2,"mode":"output","state":"high","unit":"V"}
        const s = JSON.parse(msg);
        document.getElementById(`m_mode${s.index}`).innerText = s.mode;
        document.getElementById(`m_state${s.index}`).innerText = s.state;
        document.getElementById(`m_unit${s.index}`).innerText = s.unit||'-';
        document.getElementById(`led${s.index}`).innerText = (s.state==='high'?'開':'關');
        document.getElementById(`led${s.index}`).className = 'badge bg-' + (s.state==='high'? 'danger':'success');
      }
      if (topic==='esp32/ack_config') {
        log('🎉 IO 設定已生效');
      }
    });

    // IO 設定存檔
    document.getElementById('configForm').addEventListener('submit', e => {
      e.preventDefault();
      const cfg = { gpio: [], logic: document.getElementById('logicTextarea').value };
      for (let i=0; i<10; i++) {
        cfg.gpio.push({
          index: i,
          pin: validPins[i],
          mode: e.target[`mode${i}`].value
        });
      }
      client.publish('esp32/config', JSON.stringify(cfg));
      log('📤 發送 IO 設定');
    });

    // 遠端開關某一組 IO
    function toggleIO(idx) {
      const msg = { index: idx, cmd: 'toggle' };
      client.publish('esp32/control', JSON.stringify(msg));
      log(`📤 切換 IO ${idx}`);
    }

    // 邏輯存檔
    document.getElementById('saveLogicBtn').addEventListener('click', () => {
      const logic = document.getElementById('logicTextarea').value;
      client.publish('esp32/config', JSON.stringify({ gpio: [], logic }));
      log('📤 發送自動控制邏輯');
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
