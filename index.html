<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 GPIO 控制面板</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 6px; }
    .status { width: 60px; text-align: center; }
    .btn { cursor: pointer; padding: 4px 8px; }
    .disabled { color: gray; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>ESP32 GPIO 控制面板</h2>
  <table id="gpioTable">
    <tr><th>Index</th><th>Pin</th><th>Mode</th><th>Name</th><th>Unit</th><th>Status</th><th>Control</th></tr>
  </table>

  <script>
    const client = mqtt.connect("wss://broker.mqttgo.io:8084/mqtt");

    let gpioData = [];

    client.on('connect', () => {
      console.log("MQTT Connected");
      client.subscribe("esp32/config");
      client.subscribe("esp32/status");
    });

    client.on('message', (topic, message) => {
      const data = JSON.parse(message.toString());

      if (topic === "esp32/config") {
        gpioData = data.gpio;
        renderTable();
      } else if (topic === "esp32/status") {
        const row = document.getElementById("row-" + data.index);
        row.querySelector(".status").innerText = data.state.toUpperCase();
      }
    });

    function renderTable() {
      const table = document.getElementById("gpioTable");
      table.innerHTML = `<tr><th>Index</th><th>Pin</th><th>Mode</th><th>Name</th><th>Unit</th><th>Status</th><th>Control</th></tr>`;
      gpioData.forEach((gpio, i) => {
        const tr = document.createElement("tr");
        tr.id = "row-" + gpio.index;
        tr.innerHTML = `
          <td>${gpio.index}</td>
          <td>${gpio.pin}</td>
          <td>${gpio.mode}</td>
          <td contenteditable="true">${gpio.name}</td>
          <td contenteditable="true">${gpio.unit}</td>
          <td class="status">?</td>
          <td>
            ${gpio.mode === "output"
              ? `<button class="btn" onclick="toggle(${gpio.index})">切換</button>`
              : `<span class="btn disabled">無效</span>`}
          </td>
        `;
        table.appendChild(tr);
      });
    }

    function toggle(index) {
      client.publish("esp32/control", JSON.stringify({ index }));
    }
  </script>
</body>
</html>
